<html lang="pt">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>UAP Authentication</title>

	<!-- Custom fonts for this template-->
	<link href="/templates/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">

	<!-- Page level plugin CSS-->
	<link href="/templates/vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

	<!-- Custom CSS para template-->
	<link href="/templates/css/sb-admin.css" rel="stylesheet">

	<style>
		.register-form h1 {
			text-align: center;
			font-size: 24px;
			padding: 20px 0 20px 0;
			font-family: sans-serif;
		}

		input[type=password] {
			width: 100%;
			padding: 15px;
			margin: 5px 0 22px 0;
			display: inline-block;
			border: none;
			background: #f1f1f1;
		}

		.registerbtn {
			background-color: #0080ff;
			color: white;
			padding: 16px 20px;
			margin: 8px 0;
			border: none;
			cursor: pointer;
			width: 100%;
		}

		#logoutForm {
			position: absolute;
			right: 10px;
			top: 25%;
		}

		#footer {
			position: fixed;
			background-color: #0080ff;
			width: 100%;
			height: 75px;
		}
	</style>

</head>

<body id="page-top" style="background-color: lightgrey;">

	<!-- NAVBAR -->
	<nav class="navbar navbar-expand navbar-dark bg-primary static-top" id="navbar" style="background-color: white">
		<a class="navbar-brand mr-1" href="/"> <i class="fa fa-home" style="font-size:20px"></i> User Authentication
			Application</a>
		{% if session['username'] %}
		<form action="/logout?_method=DELETE" method="post" id="logoutForm">
			<i class="fas fa-sign-out-alt" style="color: white;"></i> <button type="submit"
				style="color: white; text-align: left; border: none; background-color: transparent;">Logout</button>
		</form>
		{% endif %}
	</nav>

	<div id="wrapper">

		<div id="content-wrapper">

			<div class="container-fluid">

				<div class="alert alert-warning" role="alert" hidden id="msg1">
                    If your Authentication Key was correct, then you don't have any account details in the UAP linked to this DNS!
                </div>
				
				<div class="alert alert-danger" role="alert" hidden id="msg2">
                    There was an error in the database! Please try again later.
                </div>

				<div class="alert alert-danger" hidden id="HANDSHAKE" role="alert">
					The E-CHAP procotol has failed! 
					<p></p>
					Error in the HANDSHAKE phase.
				</div>

				<div class="alert alert-danger" hidden id="AUTHORIZATION" role="alert">
					The E-CHAP procotol has failed! 
					<p></p>
					Error in the AUTHORIZATION phase.
				</div>

				<div class="alert alert-danger" hidden id="CALCULATE_CHALLENGE_RESPONSE" role="alert">
					The E-CHAP procotol has failed! 
					<p></p>
					Error in the CALCULATE_CHALLENGE_RESPONSE phase.
				</div>

				<div class="alert alert-danger" hidden id="AUTHENTICATION" role="alert">
					The E-CHAP procotol has failed! 
					<p></p>
					Error in the AUTHENTICATION phase.
				</div>

				<div class="alert alert-danger" hidden id="UNFORSEEN" role="alert">
					An unforseen error has occurred! Please try again later.
				</div>

				<div class="card mb-3" style="padding: 0px 20% 0px 20%">

					<div id="container">
						<div id="left-column">
							<h1 style="text-align: center; padding-bottom: 2%; padding-top: 2%;">Log into {{clientDNS}}
							</h1>
							<h5 style="text-align: center; padding-bottom: 2%; padding-top: 2%;">An Enhanced Challenge-Response Protocol will be used for authentication.</h5>

							<body>
								<div class="login-form">

									<!-- Authenticate with UAP-->
									<body>
										<div class="login-form" style="padding: 5px 20% 5px 20%">
												<input hidden id = "dnsVl" value="{{clientDNS}}"> 
												<input hidden id = "endP" value="{{startEndpoint}}"> 
												<input type="password" name="key" placeholder="Enter Authentication Key"
													id="key" required>
												<button type="submit" class="registerbtn" id = "queryBtt" onclick="listAvailAccounts()">Show Available Accounts</button>
										</div>
									</body>
								</div>
							</body>
						</div>
					</div>

                    <!-- LISTING OF AVAILABLE ACCOUNTS -->
                    <div id="container2" style="padding-top: 10%;">
                        <table class="table" id="tableOfContents">
                            {% for items in allAccounts %}
                            <tr>
                                <td style="text-align:center">{{items[0]}}</td>
                                <td style="text-align:center">{{items[1]}}</td>
                                <td style="text-align:center">
                                    <button class="btn btn-primary" onclick="startECHAPprotocol(this)">
                                        Manage Account
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
		</div>
					 
</body>

<!-- FOOTER -->
<footer class="sticky-footer" id="footer">
	<div class="container my-auto">
		<div class="copyright text-center my-auto">
		</div>
	</div>
</footer>

<!-- Bootstrap core JavaScript-->
<script src="/templates/vendor/jquery/jquery.min.js"></script>
<script src="/templates/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/templates/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/templates/js/sb-admin.min.js"></script>


<!-- List all accounts in UAP that are registered with the requested DNS -->
<script>
    function listAvailAccounts() {
		document.getElementById("msg1").hidden = true;
		document.getElementById("msg2").hidden = true;
		userKey = document.getElementById("key").value;
		dns_value = document.getElementById("dnsVl").value;

        fetch('/show-possible-accounts', {
            method: 'post',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dnsName: String(dns_value),
                uKey: String(userKey),
            })
			}).then(result => result.json()).then(parsedData => {
				var toc = document.getElementById("tableOfContents");
				toc.innerHTML = "";
				var tblHTML = "";

				if(parsedData.codeValue == 2){
					document.getElementById("msg1").hidden = false;
					return
				}

				if(parsedData.codeValue == 3){
					document.getElementById("msg2").hidden = false;
					return
				}
				
				else{
					for (var i = 0; i < parsedData.availAccounts.length; i++) {
					tblHTML += "<tr><td style=\"text-align:center\">" + parsedData.availAccounts[i][0] + "</td>"
					tblHTML += "<td style=\"text-align:center\">" + parsedData.availAccounts[i][1] + "</td><td style=\"text-align:center>"
                    tblHTML += '<button hidden"></button>'
					tblHTML += '<button class="btn btn-primary" id="btn" onclick="startECHAPprotocol(this)"> Use this Account</button>'; 
					tblHTML += "</td></tr>"
					}
					toc.innerHTML = tblHTML;
				}
			})
    }
</script>


<!-- ECHAP PROTOCOL ON UAP SIDE WILL RUN HERE -->
<script>
	function startECHAPprotocol(arg1){
		email_value = arg1.parentNode.previousSibling.innerHTML
		dns_value = arg1.parentNode.previousSibling.previousSibling.innerHTML
		endpoint = document.getElementById("endP").value;
		Mkey = document.getElementById("key").value;
		failureAT = ''

		fetch(dns_value + '/' + endpoint, {  // SEND HANDSHAKE
            method: 'post',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                msg: String("Hello"),
                step: String("HANDSHAKE"),
            })

		}).then(result => result.json()).then(parsedData => { 
			if(parsedData.Val===1){
				failureAT="HANDSHAKE"
			}
			endpoint2 = parsedData.nextPoint
			val2 = parsedData.Val
			
			fetch(dns_value + endpoint2, {	// REQUEST AUTHORIZATION
            method: 'post',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                msg: String(email_value),
                step: String("AUTHORIZATION"),
				val: Number(val2)
            })
			}).then(result => result.json()).then(parsedData2 => { 
				if(parsedData2.Val===1 && failureAT===''){
					failureAT="AUTHORIZATION"
				}
				nonce = parsedData2.msg
				endpoint3 = parsedData2.nextPoint
				val3 = parsedData2.Val
				salt = parsedData2.salt

				fetch('/calculate_challenge', {	// CALCULATE CHALLENGE_RESPONSE
					method: 'post',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						key: String(Mkey),
						email: String(email_value),
						dns: String(dns_value),
						cNonce: String(nonce),
						csalt: String(salt)
					})
				}).then(result => result.json()).then(parsedData3 => { 
					if(parsedData3.Val===1 && failureAT===''){		   
						failureAT="CALCULATE_CHALLENGE_RESPONSE"
					}

					fetch(dns_value + endpoint3, {	// REQUEST AUTHENTICATION BY SENDING CHALLENGE RESPONSE
						method: 'post',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							msg: String(parsedData3.resp),
							step: String("CHALLENGE_RESPONSE"),
							Unonce: String(nonce),
							email: String(email_value),
							val: Number(val3)
						})
					}).then(result => result.json()).then(parsedData4 => {	// REDIRECT TO REQUIRED DNS LOGIN IF AUTHENTICATION SUCCESS
						console.log(parsedData4)
						if(parsedData4.msg==="SUCCESS"){					// ERROR MESSAGE IF AUTHENTICATION FAILURE
							window.location.href = parsedData4.goTo
						}
						else{
							if(parsedData4.msg==="FAILURE" && failureAT===''){
								failureAT="AUTHENTICATION"
							}

							if(failureAT==="HANDSHAKE"){
								document.getElementById("HANDSHAKE").hidden = false
							}

							else if(failureAT==="AUTHORIZATION"){
								document.getElementById("AUTHORIZATION").hidden = false
							}

							else if (failureAT==="CALCULATE_CHALLENGE_RESPONSE"){
								document.getElementById("CALCULATE_CHALLENGE_RESPONSE").hidden = false
							}

							else if (failureAT==="AUTHENTICATION"){
								document.getElementById("AUTHENTICATION").hidden = false
							}
							else{
								document.getElementById("UNFORSEEN").hidden = false
							}
						}
					})
			})
		})
		}
	)}
</script>

</html>